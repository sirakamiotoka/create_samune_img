<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>あなたが頼りです。</title>
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">


  <style>
@font-face {
  font-family: 'GenEiMGothic';
  src: url('font/GenEiMGothic2-Heavy.woff2') format('woff2'),
       url('font/GenEiMGothic2-Heavy.woff') format('woff'),
       url('font/GenEiMGothic2-Heavy.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
  font-display: swap;
}
    body {
      font-family: sans-serif;
    }
    canvas {
      border: 1px solid #ccc;
      display: block;
      max-width: 100%;
      height: auto;
    }
    .number-box, .text-box {
      width: 200px;
      padding: 10px;
      font-size: 16px;
      margin-top: 10px;
    }
    .input-group {
      margin-bottom: 10px;
    }
    #previewImage {
      max-width: 100%;
      margin-top: 10px;
      display: none;
    }
    #saveBtn {
      display: none;
    }
  </style>
</head>
<body>

<h3>↓画像を入れてクレメンス↓</h3>

<div class="input-group">
  背景: <input type="file" id="backgroundInput" accept="image/*" />
</div>
<div class="input-group">
  立ち絵: <input type="file" id="charaInput" accept="image/*" />
</div>
<div class="input-group">
  <label for="hueInput">枠とメイン文字の色を調整(適当な数値を入力):</label>
  <input type="number" id="hueInput" class="number-box" value="0" />
</div>
<div class="input-group">
  <label for="textInput">サブ文字を入力:</label>                  
  <input type="text" id="textInput" class="text-box" placeholder="例：○○が行く！" />
</div>
<div class="input-group">
  <label for="textInput">メイン文字を入力（ゲーム名など）:</label>
  <input type="text" id="textmainInput" class="text-box" placeholder="例：ランクマッチ" />
</div>
<div class="input-group">
  <label for="textInput">企画名等を入力（５連勝するまで！など）:</label>
  <input type="text" id="textprojInput" class="text-box" placeholder="例：クリアまで耐久" />
</div>
<div class="input-group">
  <label>
    <input type="checkbox" id="liveToggle" checked />
    LIVE配信用
  </label>
</div>

<canvas id="thumbCanvas" width="1280" height="720"></canvas>
<img id="previewImage" alt="プレビュー画像" />

<script>
  const canvas = document.getElementById('thumbCanvas');
  const ctx = canvas.getContext('2d');
  const previewImage = document.getElementById('previewImage');

  let bgImage = null;
  let charaCropped = null;
  let hueValue = 0;
  let overlayText = "";
  let overlayTextmain = "";
  let overlayTextproj = "";
  let showLive = true;
document.getElementById('liveToggle').addEventListener('change', (e) => {
  showLive = e.target.checked;
  drawAll();
});

  const frameImage = new Image();
　frameImage.crossOrigin = 'anonymous';
  frameImage.src = 'img/枠.png';

  const liveImage = new Image();
　liveImage.crossOrigin = 'anonymous';
  liveImage.src = 'img/ライブ.png';

  let frameLoaded = false;
  let liveLoaded = false;

  frameImage.onload = () => {
    frameLoaded = true;
    drawAll();
  };

  liveImage.onload = () => {
    liveLoaded = true;
    drawAll();
  };

  function isMobile() {
    return /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
  }

  function updateUIByDevice() {
    if (isMobile()) {
      canvas.style.display = 'none';
    previewImage.style.display = 'block';
    
  } else {
    canvas.style.display = 'block';
    previewImage.style.display = 'none';
  }
  }

  window.addEventListener('load', () => {

   
  updateUIByDevice();
  drawAll();
  });

  function drawAll() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (bgImage) {
      ctx.drawImage(bgImage, 0, 0, canvas.width, canvas.height);
    } else {
      ctx.fillStyle = '#eee';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    if (frameLoaded) {
      ctx.save();
      ctx.filter = `hue-rotate(${hueValue}deg)`;
      ctx.drawImage(frameImage, 0, 0, canvas.width, canvas.height);
      ctx.restore();
    }

    if (charaCropped) {
      const maxWidth = 550;
      const maxHeight = 550;

      const aspectRatio = charaCropped.width / charaCropped.height;
      let drawWidth = maxWidth;
      let drawHeight = maxWidth / aspectRatio;

      if (drawHeight > maxHeight) {
        drawHeight = maxHeight;
        drawWidth = maxHeight * aspectRatio;
      }

      const x = -100;
      const y = canvas.height - drawHeight + (drawHeight / 6);
      ctx.drawImage(charaCropped, x, y, drawWidth, drawHeight);
    }

    if (liveLoaded && showLive) {
    ctx.drawImage(liveImage, 0, 0, canvas.width, canvas.height);
    }


    // 文字
    if (overlayText) {
  ctx.save();
  ctx.font = '100px "Noto Sans JP", "Impact", "Yu Gothic", "Meiryo", sans-serif';

  ctx.textAlign = 'left';
  ctx.textBaseline = 'top';

 ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
  ctx.shadowBlur = 8;
  ctx.shadowOffsetX = 4;
  ctx.shadowOffsetY = 4;
  ctx.fillStyle = '#ffffff';
  ctx.strokeStyle = '#000000';

  const textX = canvas.width / 2 - 203;
  const textY = 140;
ctx.lineWidth = 8;
  ctx.scale(1, 1.32);
  ctx.translate(textX, textY);
  
  ctx.strokeText(overlayText, 0, 0);
  ctx.fillText(overlayText, 0, 0);
  ctx.restore();
}



    if (overlayTextmain) {
  ctx.save();
  let fontSize = 179;
  ctx.font = '179px "Noto Sans JP", "Impact", "Yu Gothic", "Meiryo", sans-serif';
  while (ctx.measureText(overlayTextmain).width > canvas.width * 0.65 && fontSize > 114) {
    fontSize -= fontSize/10-5;
    ctx.font = `bold ${fontSize}px "Noto Sans JP", "Impact", "Yu Gothic", "Meiryo", sans-serif`;

  }
　ctx.font = `bold ${fontSize}px "Noto Sans JP", "Impact", "Yu Gothic", "Meiryo", sans-serif`;
  ctx.textAlign = 'left';
  ctx.textBaseline = 'top';
 ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
  ctx.shadowBlur = 8;
  ctx.shadowOffsetX = 5;
  ctx.shadowOffsetY = 5;
  ctx.fillStyle = '#f0ff0f';
  ctx.strokeStyle = '#000000';
  ctx.filter = `hue-rotate(${hueValue}deg)`;

  const textX = canvas.width / 2 - 190;
  const textY = 235;
  ctx.lineWidth = 13;
  ctx.scale(1, 1.38);
  ctx.translate(textX, textY);
  ctx.strokeText(overlayTextmain, 0, 0);
  ctx.fillText(overlayTextmain, 0, 0);
  ctx.restore();
}
if (overlayTextproj) {
  ctx.save();
  let fontSize = 95;
  ctx.font = '95px "Noto Sans JP", "Impact", "Yu Gothic", "Meiryo", sans-serif';
  while (ctx.measureText(overlayTextproj).width > canvas.width * 0.65 && fontSize > 35) {
    fontSize -= fontSize/10-5;
    ctx.font = `bold ${fontSize}px "Noto Sans JP", "Impact", "Yu Gothic", "Meiryo", sans-serif`;

  }
　ctx.font = `bold ${fontSize}px "Noto Sans JP", "Impact", "Yu Gothic", "Meiryo", sans-serif`;
  ctx.textAlign = 'left';
  ctx.textBaseline = 'top';
  ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
  ctx.shadowBlur = 8;
  ctx.shadowOffsetX = 5;
  ctx.shadowOffsetY = 5;
  ctx.fillStyle = '#f0ff0f';
  ctx.strokeStyle = '#000000';
  ctx.filter = `hue-rotate(${hueValue - 45}deg)`;

  const textX = canvas.width / 2 - 190;
  const textY = 435;
  ctx.lineWidth = 9;
  ctx.scale(1, 1.3);
  ctx.translate(textX, textY);
  
  ctx.strokeText(overlayTextproj, 0, 0);
  ctx.fillText(overlayTextproj, 0, 0);
  ctx.restore();
}


    updatePreview();
  }

 function updatePreview() {
  if (isMobile()) {
    previewImage.src = canvas.toDataURL('image/png');
  }
}


  document.getElementById('backgroundInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const img = new Image();
    img.onload = () => {
      bgImage = img;
      drawAll();
      updatePreview();
    };
    img.src = URL.createObjectURL(file);
  });

  document.getElementById('charaInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const img = new Image();
    img.onload = () => {
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      tempCanvas.width = img.width;
      tempCanvas.height = img.height;
      tempCtx.drawImage(img, 0, 0);

      const imageData = tempCtx.getImageData(0, 0, img.width, img.height);
      const data = imageData.data;

      let top = img.height, left = img.width, right = 0, bottom = 0;

      for (let y = 0; y < img.height; y++) {
        for (let x = 0; x < img.width; x++) {
          const idx = (y * img.width + x) * 4;
          const alpha = data[idx + 3];
          if (alpha > 0) {
            if (x < left) left = x;
            if (x > right) right = x;
            if (y < top) top = y;
            if (y > bottom) bottom = y;
          }
        }
      }

      const cropWidth = right - left + 1;
      const cropHeight = bottom - top + 1;

      const croppedCanvas = document.createElement('canvas');
      croppedCanvas.width = cropWidth;
      croppedCanvas.height = cropHeight;
      const croppedCtx = croppedCanvas.getContext('2d');
      croppedCtx.drawImage(img, left, top, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

      const croppedImg = new Image();
      croppedImg.onload = () => {
        charaCropped = croppedImg;
        drawAll();
        updatePreview();
      };
      croppedImg.src = croppedCanvas.toDataURL();
    };
    img.src = URL.createObjectURL(file);
  });

  document.getElementById('hueInput').addEventListener('input', () => {
    hueValue = parseInt(document.getElementById('hueInput').value) || 0;
    drawAll();
  });

  // 見出し入力
  document.getElementById('textInput').addEventListener('input', (e) => {
    overlayText = e.target.value;
    drawAll();
    
  });
  // メインタイトル入力
  document.getElementById('textmainInput').addEventListener('input', (e) => {
    overlayTextmain = e.target.value;
    drawAll();
  });
  // 企画名等入力
  document.getElementById('textprojInput').addEventListener('input', (e) => {
    overlayTextproj = e.target.value;
    drawAll();
  });
</script>

</body>
</html>
